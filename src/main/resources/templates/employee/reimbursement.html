<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/master}">
<head>
<style type="text/css">
.highcharts-exporting-group {
	display: none;
}

.slidebox {
	padding: 14px;
	margin-top: 0px;
	margin: 0px 10px;
}

.formValidation1 {
    font-size: 10px;
    font-weight: 100;
    color: #ff9e99;
    background-color: transparent;
    position: relative;
    top: -1px;
    padding: 3px 0;
}
.holdCls {
	background-color: rgb(0, 143, 0);
}

.bg_white {
	background: #ffffff !important;
}
</style>

<script type="text/javascript" charset="utf-8">
	$(document).ready(function() {
				$('#refno').show();
				$('#upload').show();
				$('#amountrequired').hide();
				$('#amount').hide();
				$('#dateExpnc').hide();
				$('#dateExpnc1').show();
				
				$("#add").show();
				var dateFormat = localStorage.getItem("dateFormat");
				$("#expenseDateCalendar12").datetimepicker({
					format : dateFormat,
					closeOnDateSelect : true,
					timepicker : false,
					maxDate : new Date(),
				}).on("change", function() {
					$('#expenseDate12').val($(this).val());
				})

				$('#expenseDate12').blur(function() {
					$("#expenseDateCalendar12").val($(this).val());
				})
				

				
				$("#delete").attr("disabled", true);
				$("#initiate").attr("disabled", true);
				$("#payment").attr("disabled", true);
				$("#approve").attr("disabled", true);
		    	$("#reject").attr("disabled", true);
				
				$("#fin").hide();
 

				$('.collapse').on('show.bs.collapse', function() {
					$(this).siblings('.panel-heading').addClass('active');
				});

				$('.collapse').on('hide.bs.collapse', function() {
					$(this).siblings('.panel-heading').removeClass('active');
				});

				var gridDiv = document.querySelector('#myGrid');
				new agGrid.Grid(gridDiv, gridOptions);
				

				 var userid = $("#sessionId").val();
				var userrole = $("#sessionRole").val();
				var roleid = "";
				for(var i = 6; i <= userrole.length; i=i+6){  
				    roleid = roleid + '"' +userrole.slice(i-6, i)+ '",';
				}
				roleid = roleid.substring(0, roleid.length - 1); 

				//reimbursement-view
				agGrid.simpleHttpRequest({
					url : "reimbursement-view-through-ajax?userid=" + userid+"&roleid="+roleid,
				}).then(function(data) {
					console.log(data)
					var len = data.length;
					$('#totalReim').find('span').html(len);
					gridOptions.api.setRowData(data);
				});

				$("#demo").hide();

				$('#docTbl').on('click', '.rmv1', function() {
					openDeleteConfirm();
					var value = $(this).parent("div").attr("id");
					$("#dltValue").val(value);
				});

				$("#statusDiv").hide();
				$('.collapse').on('show.bs.collapse', function() {
					$(this).siblings('.panel-heading').addClass('active');
				});

				$(function() {
					$("input[name='advanceReq']").click(function() {
						if ($("#No").is(":checked")) {
							$("#amount").hide();
						} else {
							$("#amount").show();
						}
					});
				});

				var dateFormat = localStorage.getItem("dateFormat");
				
				$("#reqType").on('change', function() {
					var reqtype = $(this).val();			
					if (reqtype =="1") {
						if ($("#No").is(":checked")) {
							$("#amount").hide();
						} else {
							$("#amount").show();
						}
					$("#expenseDateCalendar1").datetimepicker({
						format : dateFormat,
						closeOnDateSelect : true,
						timepicker : false,
						minDate : new Date(),
				    }).on("change", function() {
					$('#expenseDate1').val($(this).val());
				    })

				    $('#expenseDate1').blur(function() {
					$("#expenseDateCalendar1").val($(this).val());
				    })
					$('#refno').hide();
					$('#upload').hide();
					$('#amountrequired').show(); 
					$('#dateExpnc').show();
					$('#dateExpnc1').hide();
					}			
					else
						{
						$("#expenseDateCalendar12").datetimepicker({
							format : dateFormat,
							closeOnDateSelect : true,
							timepicker : false,
							maxDate : new Date(),
						}).on("change", function() {
							$('#expenseDate12').val($(this).val());
						})

						$('#expenseDate12').blur(function() {
							$("#expenseDateCalendar12").val($(this).val());
						})
						
						$('#refno').show();
						$('#upload').show();
						$('#amountrequired').hide();
						$('#amount').hide();
						$('#dateExpnc').hide();
						$('#dateExpnc1').show();
				}		
			});
 

				
                $("#expenseDateCalendar").datetimepicker({
					format : dateFormat,
					closeOnDateSelect : true,
					timepicker : false,
				}).on("change", function() {
					$('#expenseDate').val($(this).val());
				})

				$('#expenseDate').blur(function() {
					$("#expenseDateCalendar").val($(this).val());
				})
				
				//date time picker
				$("#transactionDate").datetimepicker({
					format : 'd-m-Y',
					closeOnDateSelect : true,
					minDate : new Date(),
					timepicker : false,
				})
				var currentDate = twoDigitDate + "-" + twoDigitMonth + "-"
						+ fullDate.getFullYear();
				$("#transactionDate").val(currentDate);
				HideBank();
				$("#form").hide();
				$("#cancel").hide();
				$("#save").hide();
				$('#delete').attr("disabled", true);
				$("#myGrid").show();
				
				

				$('#docTbl').on('click', '.rmv1', function() {
					openDeleteConfirm();
					var value = $(this).parent("div").attr("id");
					$("#dltValue").val(value);
				});

				$("#statusDiv").hide();
				$('.collapse').on('show.bs.collapse', function() {
					$(this).siblings('.panel-heading').addClass('active');
				});

				$(function() {
					$("input[name='advanceReq']").click(function() {
						if ($("#No").is(":checked")) {
							$("#amount").hide();
						} else {
							$("#amount").show();
						}
					});

				});
	
				
			});
	
	/* -------------------search bar for mygrid------------------------ */

	function onQuickFilterChanged() {
		gridOptions.api
				.setQuickFilter(document.getElementById('quickFilter').value);
	}

	function cancelBar() {
		var id = document.getElementById("closeKey");
		id.style.display = "block";

		if ($('#quickFilter').val() == null || $('#quickFilter').val() == "") {
			id.style.display = "none";
		}
	}
	//Reimbursement Management
	const columnDefs = [
			{
				headerCheckboxSelection : false,
				headerCheckboxSelectionFilteredOnly : true,
				checkboxSelection : true,
				width : 10,
				sortable : false,
				filter : false,
				resizable : true
			},
			{
				headerName : 'Reimbursement Id',
				field : "reimbursementReqId",
				width : 170,
				cellRenderer : function(params) {
					 var sempid=$("#sessionId").val();
						if (params.data.empID1==sempid && params.data.approveStatus=="Pending") {
							return '<a id="" onclick=editPage("' + params.data.reimbursementReqId+','+params.data.empID1+','+params.data.approveStatus+','+params.data.reqType
							+ '") href="javascript:void(0)">'+ params.data.reimbursementReqId + '</a>';
						}else{
							return '<div>'+params.data.reimbursementReqId+'</div>';
						}
				}
			}, {
				headerName : 'Requisition Type',
				field : "reqTypeName",
				width : 160,
			}, {
				headerName : 'Employee Name',
				field : "createdBy",
				width : 180,
			},  {
				headerName : 'Apply Date',
				field : "applyDate"
			}, {
				headerName : 'Expense Date',
				field : "expenseDate1"
			},
			 {
				headerName : 'Amount',
				field : "eAmount"
				
			},
			{
				headerName : 'Expense Description',
				field : "descExpense",
				width : 200,
			},
			{
				headerName : 'Approve Status',
				field : "approveStatus",
				cellRenderer : function(params) {
					if (params.data.approveStatus =="Pending") { 
						return '<div style="color:#a9a9a9">Pending</div>';
					} else if (params.data.approveStatus =="Forwarded") {
						return '<div style="color:#ffa500">Forwarded</div>';
					} else if (params.data.approveStatus =="Approved") {
						return '<div style="color:#0642f5">Approved</div>';
					} else if (params.data.approveStatus =="Rejected"){
						return '<div style="color:#ff8242">Rejected</div>';
					}else{
						return '<div style="color:#9932CC">completed</div>';
					}	
				} 	
			}, {
				headerName : 'Purpose',
				field : "travellingPurpose"
			}, {
				headerName : 'Advance Required',
				field : "advanceReq",
				width : 200,
			},
			{
				headerName : 'Advance Amount',
				field : "advanceAmount",
				width : 200,
			},{
				headerName : 'Reference Number',
				field : "referenceNo1",
				width : 200,
			},{
				headerName : 'Receipt',
				field : "docName1",
				width : 120,
				cellRenderer : function(params) {
					var div = "";
					if (params.data.docName1) {
						var ext = params.data.docName1.split(".");
						if (ext[1] == "pdf") {
							div = div
							+ " "
							+ '<div class ="fa fa-file-pdf-o" style="cursor: pointer; color: red;" onclick=viewImage("'+ params.data.docName1 + '")> </div>';
						}else{
							div = div
							+ " "
							+ '<div class ="fa fa-picture-o" style="cursor: pointer; color: blue;" onclick=viewImage("'+ params.data.docName1 + '")> </div>';
						}
					}
					return div;
				}
			},
			{
				headerName : 'Approved By',
				field : "approvedBy"
			}, {
				headerName : 'Rejected By',
				field : "rejectedBy"
			},{
				headerName : 'Comments',
				field : "approveComment",
				width : 240
			} ];


	//Reimbursement management
	const gridOptions = {
		columnDefs : columnDefs,
		defaultColDef : {
			sortable : true,
			filter : true,
			resizable : true,
			width : 150,
			height : 10
		},
		rowSelection : 'single',
		onSelectionChanged : rowSelectId,
		suppressRowClickSelection : true,
		getRowNodeId : function(data) {
			return data.reimbursementReqId;
		}
	};
 
	var deleteId = " ";
	var rId="";
	function rowSelectId() {
		 var selectedNodes = gridOptions.api.getSelectedNodes();
		 var selectedData = selectedNodes.map(node => node.data);
		 deleteId = selectedData.map(node => node.reimbursementReqId);
		 rId= selectedData.map(node => node.reimbursementReqId);
     	 var empID= selectedData.map(node => node.empID1);
		// var empID = $("#sessionId").val();
		 
		var selectedRows = gridOptions.api.getSelectedRows();
		id = "";
		 var rowCount = 0;
		for (var i = 0; i < selectedRows.length; i++) {
			id = id + '"' + selectedRows[i].reimbursementReqId+ '"';
		     rowCount = rowCount + 1;
		}
			 var uid=$("#sessionId").val();
			 var adRole=$("#adRole").val();
		   if (rowCount > 0) {
				$('#add').attr('disabled', true);
				if(empID!=uid){
					 if ((selectedData.map(node => node.approveStatus)!="Approved") && (selectedData.map(node => node.approveStatus) != "Forwarded")&&(selectedData.map(node => node.approveStatus) != "Rejected")&&(selectedData.map(node => node.approveStatus) != "Pending")) {
				        	$('#approve').attr('disabled', true);
							$('#reject').attr('disabled', true);
							$('#delete').attr("disabled", false);
				 
					 } else if (selectedData.map(node => node.approveStatus) =="Approved"){
						 $('#approve').attr('disabled', false);
						 $('#reject').attr('disabled', false);
					 }
					 else {
				         	$('#approve').attr('disabled', false);
							$('#reject').attr('disabled', false);
							$('#delete').attr("disabled", true);
				        } 
				    }else{
						if(adRole=='rol001' || adRole=='rol010'){
							if(selectedData.map(node => node.approveStatus) == "completed"){
								$('#approve').attr('disabled', true);
								$('#reject').attr('disabled', true);
								$('#delete').attr('disabled', true);
							}else{
								$('#approve').attr('disabled', false);
								$('#reject').attr('disabled', false);
								$('#delete').attr('disabled', false);
							}
							
						}else{
							$('#approve').attr('disabled', true);
							$('#reject').attr('disabled', true);
						}
						 if (selectedData.map(node => node.approveStatus) == "Pending") {
							$('#delete').attr("disabled", false);
						}else{
							$('#delete').attr("disabled", true);
						}
				}	

    } else {
    	$('#delete').attr("disabled", true);
		$('#approve').attr('disabled', true);
		$('#reject').attr('disabled', true);
		$("#payment").attr("disabled", true);
		$("#process").attr("disabled", true);
		$('#add').attr('disabled', false);
		
		   deleteId = deleteId.substring(0, deleteId.length - 1);
    }
	}
	//Open Nav for Reimbursement
	function openNav() {

		document.getElementById("mySidenav").style.cssText = "width: 25%; position: absolute; right:-10px; overflow: hidden; height:auto;";
		document.getElementById("main").style.width = "75%";
		$("#cancel").show();
		$("#save").show();
		$("#add").attr("disabled", true);
		$("#delete").attr("disabled", true);
		$("#download").hide();
		$("#btnDiv").hide();
		$("#searchRowDiv").hide();
		
		var date = (new Date()).toISOString().split('T')[0];
		var newDate = changeDateFormat(date);
		$("#applyDate").val(newDate);
		$(".formValidation").remove();
	}
	function closeNav() {
			$("#btnDiv").show();
			$("#searchRowDiv").show();
			var userid = $("#sessionId").val();
			var userrole = $("#sessionRole").val();
			var roleid = "";
			for(var i = 6; i <= userrole.length; i=i+6){  
			    roleid = roleid + '"' +userrole.slice(i-6, i)+ '",';
			}
			roleid = roleid.substring(0, roleid.length - 1); 
			agGrid.simpleHttpRequest({
				url : "reimbursement-view-through-ajax?userid=" + userid+"&roleid="+roleid,
			}).then(function(data) {
				var len = data.length;
				$('#totalReim').find('span').html(len);
				gridOptions.api.setRowData(data);
			})
			
			    $("#reimbursementReqId").val("");
		$("#reqType").val("");
		$("#placeName").val("");
		$("#travellingPurpose").val("");
		$("#expenseDate1").val("");
		$("#descExpense").val("");
		$("#eAmount").val("");
		$("#advanceAmount").val("");
		$("#uploadFor_0").val("");
		$("#referenceNo1").val("");
		$("#download").attr("disabled", false);
		$("#download").show();
			$("#add").attr("disabled", false);
			$("#delete").attr("disabled", true);
			$("#add").show();
			document.getElementById("mySidenav").style.width = "0";
			document.getElementById("main").style.width = "100%";
		}
 
	/*
	 *Edit function
	 */

	function editPage(id) {
		openNav()
		var data = id.split(",");
		var Id=data[0];
		var empID = data[1];
		var sts = data[2];
		var type = data[3];
	    var sempid=$("#sessionId").val();
	    $('.loader').show();
		$.ajax({
			type : "GET",
			url : "reimbursement-edit-through-ajax?id=" + Id,
			async : false,
			success : function(response) {
				console.log(response)
				if (response.message == "Success") {
					if (sts== "Pending" && empID==sempid) {
						$("#save").show();
					}else {
					$("#save").hide();
					}
					$("#myGrid").show();
					$("#cancel").show();
					$("#add").hide();
					$("#delete").show();
					$("#reimbursementReqId").val(response.body.reimbursementReqId);
					$("#reqType").val(response.body.reqType);
					$("#applyDate").val(response.body.applyDate);
					$("#travellingPurpose").val(response.body.travellingPurpose);
					$("#descExpense").val(response.body.descExpense);
					$("#eAmount").val(response.body.eAmount);
					if (response.body.reqType==1){
				    	$('#refno').hide();
						$('#upload').hide();
						$('#amountrequired').show(); 
						$('#dateExpnc1').hide(); 
						$('#dateExpnc').show(); 
						if(response.body.advanceReq==1){
							$("#Yes").prop('checked', true);
							$("#amount").show();
							$("#advanceAmount").val(response.body.advanceAmount);
						}else{
							$("#No").prop('checked', true);
							$("#amount").hide();
						}
						$("#advanceAmount").val(response.body.advanceAmount);
						$("#expenseDate1").val(response.body.expenseDate1);
				    }else {
				    	$('#refno').show();
						$('#upload').show();
						$('#amountrequired').hide();
						$("#amount").hide();
						$("#expenseDate12").val(response.body.expenseDate1);
						$("#referenceNo1").val(response.body.referenceNo1);
						$('#dateExpnc1').show();
						$('#dateExpnc').hide();
						
						var fileName=response.body.docName1;
						if (fileName != null) {
							var ext = response.body.docName1.split(".");
							$("#imageName_0").html(fileName);
				           if (ext[1] == "jpg" || ext[1] == "png") {
								var LightImg = '<div class ="uploadicon position-l"><a class="example-image-link" target="_balnk"><i class="fa fa-picture-o" style="color: blue" onclick=viewImage("'
									+ fileName + '")></i></a> </div>';
							}else if (ext[1] == "pdf") {
								var LightImg = '<div class ="uploadicon position-l"><a class="example-image-link" target="_balnk"><i class="fa fa-file-pdf-o" style="color: red" onclick=viewImage("'
									+ fileName + '")></i></a> </div>';
							} else {
								var LightImg = "<div class='uploadicon position-l'> </div>";
							}  

							$("#uploadedBillDiv_0").html(LightImg);
						}
				    }
						
					$('.loader').hide();
					}else{
						$('.loader').hide();
						$("#messageParagraph").text("Something went to wrong");
						$("#msgOkModal").removeClass("btn3");
						$("#msgOkModal").addClass("btn1");
						$("#msgModal").modal('show');
					}
				
				
			}
		});
	}
	function viewImage(id){
		window.open("/document/document/"+id,'_blank');
	}	
 
	function addDetails() {
		$(".formValidation").remove();
		obj = {};
		var validation = true;
		obj.reimbursementReqId = $("#reimbursementReqId").val();
		obj.reqType= $("#reqType").val();
		obj.applyDate = $("#applyDate").val();
		obj.travellingPurpose = $("#travellingPurpose").val();
		obj.descExpense = $("#descExpense").val();
		obj.eAmount = $("#eAmount").val();
		obj.docName1 = $("#fileUpload").val();
		obj.referenceNo1 = $("#referenceNo1").val();
		obj.advanceReq = $("input[type='radio'][name='advanceReq']:checked")
				.val()
		if (obj.advanceReq == 1) {
			obj.advanceReq = "1";
			 if (obj.advanceAmount == null || obj.advanceAmount == "") {
					validation = validationUpdated("Advance Amount Required", "advanceAmount");
			}

		} else {
			obj.advanceReq = "0";
		}
		obj.advanceAmount = $("#advanceAmount").val();
		 obj.module = localStorage.getItem('module');
		obj.component = localStorage.getItem('function');
		obj.subcomponent = localStorage.getItem('activity'); 
		
		
		console.log(obj);
		
		
		 if (obj.reqType == null || obj.reqType == "") {
			validation = validationUpdated("Requisition Type is Required", "reqType");
		}
		if (obj.applyDate == null || obj.applyDate == "") {
			validation = validationUpdated("Apply Date Required", "applyDate");
		}
		if (obj.travellingPurpose == null || obj.travellingPurpose == "") {
			validation = validationUpdated("Purpose Required", "travellingPurpose");
		}
		if (obj.descExpense == null || obj.descExpense == "") {
			validation = validationUpdated("Description Required", "descExpense");
		}
		 if(obj.reqType=="1"){
			    obj.expenseDate1 = $("#expenseDate1").val();
				if (obj.expenseDate1 == null || obj.expenseDate1 == "") {
					validation = validationUpdated("Date of Expense Required", "expenseDate1");
				}
				
		 }else if(obj.reqType=="0"){
			 obj.expenseDate1 = $("#expenseDate12").val();
			 var doc = $("#imageName_0").html();
				if (obj.expenseDate1 == null || obj.expenseDate1 == "") {
					validation = validationUpdated("Date of Expense Required", "expenseDate12");
				}

				 if (obj.referenceNo1 == null || obj.referenceNo1 == "") {
						validation = validationUpdated("Reference No Required", "referenceNo1");
		          if (doc== null || doc == "") {
		        	  validation = validationUpdated("Please Upload Receipt", "validationDiv");
					}  
		 }else{
			 
		 }

		}
			 amtVal();
		if (validation && amtValid1) {
			$(".formValidation").remove();
				$('.loader').show();
			$.ajax({
				type : "POST",
				url : "reimbursement-add-details",
				contentType : "application/json",
				data : JSON.stringify(obj),
				success : function(response) {
					if (response.message == "Success") {
						$('.loader').hide();
						$("#messageParagraph").text("Data Saved Successfully");
						$("#msgOkModal").removeClass("btn3");
						$("#msgOkModal").addClass("btn1");
						$("#msgModal").modal('show');
						$("#activityone").show();
						//$("#activity").show();
						$("#add").show();
						$("#myGrid").show();
						$("#cancel").hide();
						$("#save").hide();
						$("#form").hide();
						$("#new").hide();
						closeNav();

					}else{
						$('.loader').hide();
						$("#messageParagraph").text("Something went to wrong");
						$("#msgOkModal").removeClass("btn3");
						$("#msgOkModal").addClass("btn1");
						$("#msgModal").modal('show');
					}
				},
				error : function(data) {
				}
			})
		}
	}
	//Amount validation
	var amtValid1;
	function amtVal() {
	    var val = $('#eAmount').val();
	    if (val != '') {
	        if (val>=100) {
	            $("#error9").hide();
	            amtValid1 = true;
	            return true;
	        } else {
	            $("#error9").html(
	                "Minimum Amount 100");
	        	 $("#error9").show();
	        	 amtValid1 = false;
	            return false;
	        }
	    } else {
	        $("#error9").html("Amount Required");
	        amtValid1 = false;
	        return false;
	    }
	}
 
	function saveFile1(event) {
		var uFile = $(uploadDoc_0)[0].files[0];
		var fileName = event.currentTarget.value;
		var lastIndex = fileName.lastIndexOf("\\");
		if (lastIndex >= 0) {
			fileName = fileName.substring(lastIndex + 1);
		}
		var extension = fileName.split(".");
		var iURL = URL.createObjectURL(uFile);
		$("#uploadedBillDiv_0").html("");

		if (extension[1] == "jpg" || extension[1] == "png"|| extension[1] == "jpeg") {
			var LightImg = "<div class='uploadicon position-l'><a class='example-image-link' href='" + iURL + "' title='" + fileName + "' target='_balnk'><i class='fa fa-picture-o' style='color: blue'></i></a></div>";
		}else if (extension[1] == "pdf") {
			var LightImg = "<div class='uploadicon position-l'><a class='example-image-link' href='" + iURL + "' title='" + fileName + "' target='_balnk'><i class='fa fa-file-pdf-o' style='color: red'></i></a></div>";
		} else {
			var LightImg = "<div class='uploadicon position-l'> </div>";
		}
		$("#uploadedBillDiv_0").html(LightImg);
		$("#imageName_0").html(fileName);
		var fileData = new FormData();
		fileData.append('file', uFile);
		fileData.append('path', 'none');
		$.ajax({
			type : "POST",
			url : "reimbursement-upload-file",
			enctype : "multipart/form-data",
			contentType : false,
			data : fileData,
			processData : false,
			cache : false,
			success : function(response) {
			},
			error : function(e) {

			}
		});
	}		
	function deleteData() {
		var selectedRows = gridOptions.api.getSelectedRows();
		 var id=selectedRows[0].reimbursementReqId;
		
		
			$.ajax({
				type : "POST",
				url : "reimbursement-delete-details?id="+ id,
				success : function(response) {
				 if (response.message == "Success") {
					 closeNav()
					$('#delete').attr("disabled", true);
					 	$("#messageParagraph").text(
						"Data Deleted Successfully");
						$("#msgOkModal").removeClass("btn3");
						$("#msgOkModal").addClass("btn1");
						$("#msgModal").modal('show');
				} 
				},
				error : function(data) {
				console.log(data);
				}
			})
	} 	
		
	
	
	
	function openDeleteConfirm() {
		$("#dltValue").val("");
		$('#deleteAttachment').modal('show');
	}

	//for closeing modal box for dlt ind product
	function closeDeleteConfirm() {
		$("#dltValue").val("");
		$('#deleteAttachment').modal('hide');
	}


	function changeDateFormat(inputDate){  // expects Y-m-d
	    var splitDate = inputDate.split('-');
	    if(splitDate.count == 0){
	        return null;
	    }

	    var year = splitDate[0];
	    var month = splitDate[1];
	    var day = splitDate[2]; 

	    return day + '-' + month + '-' + year;
	}

	

	 function checkAmt(fieldId) {
		 	var amt=$("#eAmount").val();
			var val=parseInt(amt);
  			if(val>=100){
				$("#" + fieldId).val(val);
			} else{
				$("#messageParagraph").text(
				"Amount must be greater than 100");
				$("#msgOkModal").removeClass("btn3");
				$("#msgOkModal").addClass("btn1");
				$("#msgModal").modal('show');
				$("#" + fieldId).val(null);
			}
		}
	
	 function check1() {
		 var amt=$("#eAmount").val();
		 var adv=$("#advanceAmount").val();
			var val=parseInt(amt);
			var val1=parseInt(adv);
				if(val>=val1)	
				{
					$("#eAmount").val(adv);
				
				}
		      else{
					$("#messageParagraph").text(
					"Advance amount must be less than or equal to amount");
					$("#msgOkModal").removeClass("btn3");
					$("#msgOkModal").addClass("btn1");
					$("#msgModal").modal('show');
					$("#advanceAmount").val(null);
					
				}
			}
	 function checkAmount(fieldId) {
			 var myField = document.getElementById("eAmount")
			 var reg = /^\d{0,8}(\.\d{0,2})?$/;   
			 var val=parseInt(myField);
			 var amt=$("#eAmount").val();
			if(amt=="00"){
				$("#" + fieldId).val(null);
			}else if (reg.test(myField.value))
			 {    
				 $("#" + fieldId).val();
				 reg = '';  
			 }else{        
				 $("#" + fieldId).val(null);    
				 }
			 }  
	 function checkAmount1(fieldId) {   
			var myField = document.getElementById("advanceAmount")
			 var reg = /^\d{0,8}(\.\d{0,2})?$/;   
			 if (reg.test(myField.value))
			 {       
				 $("#" + fieldId).val();
				 reg = '';  
			 }else{        
				 $("#" + fieldId).val(null);    
				 }
			 } 
	 function checkNum(fieldId, message) {
			//var alphaNumericRegExp = new RegExp(/^([0-9]|[a-z])+([a-z]+)$/i);
			 var tempVal = $("#" + fieldId).val().replace(/[^a-zA-Z0-9]/g, '');
			 $("#" + fieldId).val(tempVal);

		}
 
 
	function rejectRemModal() {

	    $('#commentModal').modal('toggle');
	    $("#approveRemSubmitBtn").hide();
	    $("#rejectRemSubmitBtn").show();
	}
	function approveRemModal() {

	    $('#commentModal').modal('toggle');
	    $("#approveRemSubmitBtn").show();
	    $("#rejectRemSubmitBtn").hide();

	}	
	
	/* -------------------function for approve button----------------- */
	
	var empid = "";
	var empname = "";
	function approveRem() {
		var selectedNodes = gridOptions.api.getSelectedNodes();
		 var selectedData = selectedNodes.map(node => node.data);
		 deleteId = selectedData.map(node => node.reimbursementReqId);
		 rId= selectedData.map(node => node.reimbursementReqId);
		var userrole = $("#sessionRole").val();
		var roleid = "";
		for(var i = 6; i <= userrole.length; i=i+6){  
		    roleid = roleid + '"' +userrole.slice(i-6, i)+ '",';
		}
		roleid = roleid.substring(0, roleid.length - 1); 
		empid = $("#sessionId").val();
		empname = $("#sessionName").val();
		comment = $("#comment").val();
		$.ajax({
			type : "GET",
			url : "reimbursement-details-approve?approveId=" + rId + "&name=" + empid+"&comment="+comment+"&roleid="+roleid,
			async : false,
			success : function(response) {

				if (response.message == "Success") {
					$("#messageParagraph").text(" Approved Successfully");
					$("#msgOkModal").removeClass("btn3");
					$("#msgOkModal").addClass("btn1");
					$("#msgModal").modal('show');
					closeNav();
					$('#delete').attr("disabled", true);
					$('#approve').attr('disabled', true);
					$('#reject').attr('disabled', true);
					$("#comment").val(null);
					//$("#payment").attr("disabled", true);
				}else{
					$("#messageParagraph").text("YOU’RE ALREADY APPROVED!");
					$("#msgOkModal").removeClass("btn3");
					$("#msgOkModal").addClass("btn1");
					$("#msgModal").modal('show');
					closeNav();
					$('#commentModal').modal('hide');
					$('#approve').attr('disabled', true);
					$('#delete').attr('disabled', true);
					$('#reject').attr('disabled', true);
					$("#comment").val(null);
				}

			},
			error : function(data) {
			}
		});
	} 
	
	/*-----------------------function for reject button------------------- */
	var rejempid = "";
	var rejempname = "";
	function rejectRem() {
		var selectedNodes = gridOptions.api.getSelectedNodes();
		 var selectedData = selectedNodes.map(node => node.data);
		 deleteId = selectedData.map(node => node.reimbursementReqId);
		 rId= selectedData.map(node => node.reimbursementReqId);
		rejempid = $("#sessionId").val();
		rejempname = $("#sessionName").val();
		comment = $("#comment").val();
		
		$.ajax({
			type : "GET",
			url : "reimbursement-details-reject?rejectId=" + rId + "&name=" + rejempid+"&comment="+comment,
			async : false,
			success : function(response) {

				if (response.message == "Success") {
					$("#messageParagraph").text("Rejected Successfully");
					$("#msgOkModal").removeClass("btn3");
					$("#msgOkModal").addClass("btn1");
					$("#msgModal").modal('show');
						closeNav();
					
					$('#delete').attr("disabled", true);
					$('#approve').attr('disabled', true);
					$('#reject').attr('disabled', true);
					$("#comment").val(null);
					//$("#payment").attr("disabled", true);
				}else{
					$("#messageParagraph").text("YOU’RE ALREADY REJECTED!");
					$("#msgOkModal").removeClass("btn3");
					$("#msgOkModal").addClass("btn1");
					$("#msgModal").modal('show');
					cancelBtn();
					$('#commentModal').modal('hide');
					$('#approve').attr('disabled', true);
					$('#delete').attr('disabled', true);
					$('#reject').attr('disabled', true);
					$("#comment").val(null);
				}

			},
			error : function(data) {
			}
		});
	}
	
function downloadDetails() { 
		  var dataset = [];
		  gridOptions.api.forEachNodeAfterFilterAndSort(function(rowNode, index) {
		        dataset.push(rowNode.data);
		    });
		  gridOptions.api.exportDataAsCsv(dataset);
		}	
		
function check(fieldId) {
	var tempVal = $("#" + fieldId).val().replace(/[^0-9 ]/g, '');
	$("#" + fieldId).val(tempVal);
}
function checkAlphabet(fieldId) {
	
    var tempVal = $("#" + fieldId).val().replace(/[^a-zA-Z. ]/g,'');
    tempVal=tempVal.replace(/^\w/, c => c.toUpperCase());
    
    const input = document.getElementById(fieldId);
    const position = input.selectionStart;	
    if(position == 1 && tempVal.charAt(0) == ' '){
    	$("#" + fieldId).empty();
    	tempVal = '';
   } 
   $("#" + fieldId).val(tempVal);
} 
</script>
<body>
	<div layout:fragment="content" class="maincontent">
		<div class="container-fluid">
			<div class="row">
				<div class="maincontentsec">
					<div class="content_padding">
						<div id="main_content">
							<div class="d-flex justify-content-between">
								<div class="btn-hs">
									<div class="font-design" id="totalReim">
										Reimbursement Apply(<span></span>)
									</div>
									<input type="hidden" id="sessionId" th:value="${userId}" /> <input
										type="hidden" id="sessionName" th:value="${userName}" /> <input
										type="hidden" id="hrRole" th:value="${hrRole}" /> <input
										type="hidden" id="sessionRole" th:value="${userRole}" />

								</div>
								<div id="searchRowDiv">
									<div class="input-style">
										<input type="text" placeholder="Search.." name="search"
											class="searchboxinput" onkeyup="cancelBar()"
											oninput="onQuickFilterChanged()" id="quickFilter"
											autocomplete="off">
										<div class="searchicon">
											<a href="javascript:void(0)"><span
												style="display: none; border-right: 1px solid #ccc; padding-right: 5px;"
												id="closeKey"
												onclick="gridOptions.api.setQuickFilter(null);$('#quickFilter').val('');document.getElementById('closeKey').style.display='none';"
												class="close_i"><i class="ti-close srchicon"></i></span></a><a
												href="javascript:void(0)"><i class="ti-search srchicon"></i></a>
										</div>
									</div>
								</div>
								<div class="buttonsec btn-hs" id="btnDiv">
									<button class="download-btn" id="download"
										onclick="downloadDetails()">Download</button>
									<button id="approve" class="approve-btn"
										onclick="approveRemModal()" th:if="${hrRole != null}">APPROVE</button>
									<button class="reject-btn" id="reject"
										onclick="rejectRemModal()" th:if="${hrRole != null}">Reject</button>
									<button class="delete-btn" id="delete" onclick="deleteData()">Delete</button>
									<button class="new-btn" id="add" onclick="openNav()">New</button>
								</div>
							</div>


							<div id="main">

								<input type="hidden" id="sessionId" th:value="${userId}" /> <input
									type="hidden" id="sessionName" th:value="${userName}" /> <input
									type="hidden" id="hrRole" th:value="${hrRole}" /> <input
									type="hidden" id="sessionRole" th:value="${userRole}" /> <input
									type="hidden" id="adRole" th:value="${adRole}" />
								<div id="mySidenav" class="sidenav">
									<div class="slidebox">
										<div class="row">
											<div class="col-md-10 edit">Reimbursement Details</div>
											<div class="col-md-2">
												<div class="arrow">
													<a href="javascript:void(0)" class="closebtn"
														onclick="closeNav()"><i class="ti-arrow-right"></i></a>
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-12 buttonsec btn-hs">
												<button class="approve-btn" type="submit" id="save"
													form="form" value="add" onclick="addDetails()">Save</button>
												<button class="cancel-btn" id="cancel" onclick="closeNav()">Cancel</button>
												<!-- <button class="btn3" id="delete" onclick="DeleteDetails()">Delete</button> -->
											</div>
										</div>

										<input type="hidden" id="reimbursementReqId" />
										<div class="row">
											<div class="col-md-6">
												<div class="form-group">
													<label>Requisition Type</label>
													<div class="select">
														<select id="reqType" class="form-control"
															onblur="removeValid(event)">
															<option value="0">UnApproved</option>
															<option value="1">Approved</option>
														</select>
													</div>
												</div>
											</div>
 
											<div class="col-md-6">
												<div class="form-group">
													<label>Apply Date</label> <input type="text" id="applyDate"
														autocomplete="off" class="form-control" readonly>
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-6">
												<div class="form-group">
													<label>Purpose</label> <input type="text"
														class="form-control" id="travellingPurpose"
														onblur="removeValid(event)" onkeyup="checkAlphabet('travellingPurpose');" >
												</div>
											</div>

											<div class="col-md-6" id="dateExpnc">
												<div class="form-group calendar_box">
													<label> Date Of Expense</label> <input type="text"
														id="expenseDate1" class="form-control"
														onblur="removeValid(event)"
														th:attr="onkeyup=|formatDate('expenseDate1','${session.DATEFORMAT_JS}')|" readonly>
													<i class="ti-calendar picker_calendar"
														id="expenseDateCalendar1"></i>
												</div>
											</div>
											<div class="col-md-6" id="dateExpnc1">
												<div class="form-group calendar_box">
													<label> Date Of Expense</label> <input type="text"
														id="expenseDate12" class="form-control"
														onblur="removeValid(event)"
														th:attr="onkeyup=|formatDate('expenseDate12','${session.DATEFORMAT_JS}')|" readonly>
													<i class="ti-calendar picker_calendar"
														id="expenseDateCalendar12"></i>
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-12">
												<div class="form-group">
													<label>Description</label>
													<textarea class="form-control" id="descExpense" maxLength="150"
														onblur="removeValid(event)"></textarea>
												</div>
											</div>

											<div class="col-md-6">
												<div class="form-group">
													<label> Amount</label> <input type="text" autocomplete="off"
														class="form-control" id="eAmount"
														onkeyup="checkAmount('eAmount');" onblur="removeValid(event)">
														<span id="error9" class="formValidation1"></span>
												</div>
											</div>
											<div class="col-md-6" id="refno">
												<div class="form-group">
													<label>Reference Number</label> <input type="text"
														class="form-control" id="referenceNo1" autocomplete="off" maxLength="22"
														onblur="removeValid(event)" onkeyup="checkNum('referenceNo1');" >
												</div>
											</div>
											<div class="col-md-6" id="amountrequired">
												<div class="form-group">
													<label>Advance Required</label> <br> <label for="Yes">
														<input type="radio" id="Yes" value="1" name="advanceReq" />
														Yes
													</label> <label for="No"> <input type="radio" id="No"
														value="0" name="advanceReq" checked /> No
													</label>
												</div>
											</div>
										</div>

										<div class="row">
											<div class="col-md-12" id="upload">
												<label style="margin-bottom: 10px;">Upload Receipt</label>

												<div class="control-group position-r">
													<label class="custom-file-upload" for="uploadDoc_0"
														style="margin-top: 18px;"> <i class="ti-plus"></i>
													</label>
													<div class="controls">
														<input type="file" class="document"id="uploadDoc_0"
															accept=".jpeg, .jpg, .png, .pdf" name="userImage"
															 onchange="saveFile1(event)">
													</div>
												</div>
												<input type="hidden" id="uploadHidden_0"
													class="uploadHidCls" >
												<div id="uploadedBillDiv_0" align="center"
													class="uploadedBillCls" style="margin-top: 10px;"></div>
												<div id="imageName_0" class="imageName"
													style="margin-top: 10px;"></div>

											</div>
                                            <div id="validationDiv"></div>
											<div class="col-md-12" id="amount" style="display: none;">
												<div class="form-group">
													<label>Advance Amount</label> <input type="text"
														class="form-control" id="advanceAmount"
														onchange="check1()" onkeyup="checkAmount1('advanceAmount')"
														onblur="removeValid(event)">
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="myGrid" style="width: 100%; height: 500px;"
									class="ag-theme-alpine"></div>
							</div>
						</div>

						<!-- alert modal start -->
						<div id="alert" class="modal fade show" aria-modal="true">
							<div class="modal-dialog modal-confirm">
								<div class="modal-content">
									<div class="modal-header flex-column">
										<button type="button" class="close" data-bs-dismiss="modal"
											aria-hidden="true" onclick="cancelModalBtn()">
											<i class="ti-close modal-close"></i>
										</button>
									</div>
									<div class="modal-body">
										<p id="textId"></p>
									</div>
									<div class="modal-footer justify-content-center"
										style="margin-top: -30px;">
										<button type="button" class="cancel-btn"
											data-bs-dismiss="modal" onclick="cancelModalBtn();">Close</button>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
				<!-- Modal End-->
				<div id="commentModal" class="modal fade">
					<div class="modal-dialog">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title">Comments</h4>
								<button type="button" class="close" data-bs-dismiss="modal"
									aria-label="Close">
									<i class="ti-close"></i>
								</button>
							</div>
							<div class="modal-body">
								<!-- text input -->
								<div class="row">
									<div class="col-md-12">
										<div class="form-group">
											<label>Comment</label> <input class="form-control"
												type="text" id="comment" autocomplete="off">
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer justify-content-left">
								<button type="button" class="approve-btn"
									data-bs-dismiss="modal" aria-hidden="true"
									id="approveRemSubmitBtn" onclick="approveRem()">Submit</button>
								<button type="button" class="approve-btn"
									data-bs-dismiss="modal" aria-hidden="true"
									id="rejectRemSubmitBtn" onclick="rejectRem()">Submit</button>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>
</body>
</html>
